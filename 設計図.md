# 家計簿アプリ (Smart Ledger) 詳細設計書

## バージョン履歴
| バージョン | 日付 | 内容 |
|-----------|------|------|
| v1.0.0 | 2025-12-31 | 初版リリース |
| v2.0.0 | (予定) | 背景設定、カレンダー表示、予算残額表示追加 |

## 技術スタック
- **フレームワーク**: Flutter (Dart)
- **データベース**: SQLite (sqflite)
- **状態管理**: Provider
- **グラフ**: fl_chart
- **カレンダー**: table_calendar
- **画像選択**: image_picker
- **対応プラットフォーム**: iOS, Android

---

## 1. データモデル設計 (Database Schema)

全ての基盤となるデータの構造です。
「目標達成率」と「予測」を実現するために、**支出（Transaction）**だけでなく、**予算（Budget）**の管理が不可欠です。

### ER図 (Entity Relationship Diagram)

```mermaid
erDiagram
    Category ||--o{ Transaction : "classifies"
    Category ||--o{ Budget : "has limit"
    AppSettings ||--|| User : "configures"

    Category {
        string id PK
        string name "食費, 交通費"
        string icon "icon_name"
        string color "hex_code"
        bool is_expense "true=支出, false=収入"
        int sort_order "表示順序"
    }

    Budget {
        string id PK
        string category_id FK "Nullなら全体予算"
        double amount_limit "目標金額"
        string period_type "MONTHLY"
        int year "対象年"
        int month "対象月"
    }

    Transaction {
        string id PK
        string category_id FK
        double amount
        string transaction_date "YYYY-MM-DD"
        string note "メモ"
        string created_at
        string updated_at
    }

    AppSettings {
        string id PK
        string background_type "color|image|gradient"
        string background_value "色コード or 画像パス"
        string theme_mode "light|dark|system"
        bool show_budget_remaining "残額表示ON/OFF"
        string calendar_default_view "month|week"
    }
```

### 設計のポイント
- **Budget (予算) テーブル**: カテゴリごとの予算設定も、月全体の予算設定も可能な構造（category_idがNullなら全体予算）
- **Category (分類) テーブル**: ユーザーが自由にカテゴリを追加・編集できるよう、DB管理
- **シングルユーザー設計**: スマホローカルアプリのため、Userテーブルは省略

---

## 2. フォルダ構成

```
lib/
├── main.dart                    # アプリエントリポイント
├── models/                      # データモデル
│   ├── category.dart
│   ├── transaction.dart
│   ├── budget.dart
│   └── app_settings.dart        # 【v2追加】アプリ設定
├── services/                    # ビジネスロジック・DB操作
│   ├── database_helper.dart     # SQLite操作
│   └── analysis_service.dart    # 集計・予測ロジック
├── providers/                   # 状態管理
│   ├── category_provider.dart
│   ├── transaction_provider.dart
│   ├── budget_provider.dart
│   └── settings_provider.dart   # 【v2追加】設定管理
├── screens/                     # 画面
│   ├── home_screen.dart         # ダッシュボード
│   ├── transaction_form_screen.dart  # 取引入力
│   ├── transaction_list_screen.dart  # 履歴一覧
│   ├── calendar_screen.dart     # 【v2追加】カレンダー表示
│   ├── statistics_screen.dart   # グラフ・統計
│   ├── category_screen.dart     # カテゴリ管理
│   ├── budget_screen.dart       # 予算設定
│   └── settings_screen.dart     # 【v2追加】設定画面
├── widgets/                     # 再利用可能なWidget
│   ├── summary_card.dart        # サマリーカード
│   ├── category_pie_chart.dart  # 円グラフ
│   ├── budget_progress_bar.dart # 予算進捗バー
│   ├── budget_remaining_card.dart  # 【v2追加】予算残額カード
│   ├── transaction_list_item.dart  # 取引リストアイテム
│   ├── month_selector.dart      # 月選択
│   ├── week_calendar.dart       # 【v2追加】週カレンダー
│   └── month_calendar.dart      # 【v2追加】月カレンダー
└── utils/                       # ユーティリティ
    ├── constants.dart           # 定数
    ├── theme.dart               # テーマ設定
    └── formatters.dart          # フォーマッター
```

---

## 3. 画面設計

### 3.1 ホーム画面 (Dashboard)
- 今月の支出合計
- 予算残高・消化率プログレスバー
- **【v2】予算残額の大きく表示**
- 月末着地予測
- カテゴリ別支出円グラフ
- 直近の取引リスト（5件）

### 3.2 取引入力画面
- 金額入力（テンキー）
- カテゴリ選択（アイコングリッド）
- 日付選択
- メモ入力
- 収入/支出切り替え

### 3.3 取引履歴画面
- 月別フィルター
- 取引リスト（日付でグループ化）
- スワイプで削除
- タップで編集

### 3.4 カレンダー画面【v2追加】
- 月表示/週表示の切り替え
- 日付ごとの支出・収入合計を表示
- 日付タップで取引詳細表示
- スワイプで月/週を移動

### 3.5 統計画面
- 月選択
- カテゴリ別円グラフ
- 日別推移グラフ
- カテゴリ別ランキング

### 3.6 カテゴリ管理画面
- カテゴリ一覧
- 追加・編集・削除
- アイコン・色選択

### 3.7 予算設定画面
- 月間予算設定
- カテゴリ別予算設定
- **【v2】残額表示ON/OFF設定**

### 3.8 設定画面【v2追加】
- 背景設定（色/グラデーション/画像）
- テーマ切り替え（ライト/ダーク/システム）
- カレンダーデフォルト表示設定
- データバックアップ/復元

---

## 4. 予測ロジック

```dart
/// 月末支出予測（線形予測）
/// 計算式: (現在の合計 / 経過日数) × 月の総日数
class AnalysisService {
  double predictMonthlyTotal({
    required double currentTotal,
    required int daysElapsed,
    required int daysInMonth,
  }) {
    if (daysElapsed == 0) return 0.0;
    final dailyAvg = currentTotal / daysElapsed;
    return dailyAvg * daysInMonth;
  }
}
```

---

## 5. 使用パッケージ

| パッケージ | 用途 |
|-----------|------|
| sqflite | SQLiteデータベース |
| path_provider | ファイルパス取得 |
| provider | 状態管理 |
| fl_chart | グラフ表示 |
| intl | 日付・通貨フォーマット |
| uuid | ユニークID生成 |
| table_calendar | 【v2】カレンダーUI |
| image_picker | 【v2】背景画像選択 |
| shared_preferences | 【v2】設定保存 |

---

## 6. 画面遷移図

```mermaid
flowchart TB
    subgraph BottomNav["ボトムナビゲーション"]
        Home["🏠 ホーム"]
        Calendar["📅 カレンダー"]
        History["📋 履歴"]
        Stats["📊 統計"]
        Settings["⚙️ 設定"]
    end

    Home --> AddTx["取引追加"]
    Home --> EditTx["取引編集"]
    
    Calendar --> AddTx
    Calendar --> DayDetail["日別詳細"]
    DayDetail --> EditTx
    
    History --> EditTx
    History --> AddTx
    
    Settings --> BgSettings["背景設定"]
    Settings --> CategoryMgmt["カテゴリ管理"]
    Settings --> BudgetSettings["予算設定"]
    
    BgSettings --> ColorPicker["色選択"]
    BgSettings --> ImagePicker["画像選択"]
```

---

## 7. 予算残額表示ロジック【v2追加】

```dart
/// 予算残額計算
class BudgetRemainingService {
  /// 残額 = 設定予算 - 今月の支出合計
  double calculateRemaining({
    required double budgetAmount,
    required double totalExpense,
  }) {
    return budgetAmount - totalExpense;
  }
  
  /// 1日あたりの残額
  double calculateDailyRemaining({
    required double remaining,
    required int daysLeft,
  }) {
    if (daysLeft <= 0) return 0.0;
    return remaining / daysLeft;
  }
  
  /// 残額の状態（余裕/注意/危険）
  String getRemainingStatus(double percentage) {
    if (percentage >= 0.3) return 'safe';      // 30%以上残
    if (percentage >= 0.1) return 'warning';   // 10-30%残
    return 'danger';                            // 10%未満
  }
}
```

---

## 8. 開発フェーズ (Roadmap)

### Phase 1: 「記録する」 (MVP) ✅ v1.0.0完了
- [x] データベース設計・実装
- [x] 取引の追加・編集・削除
- [x] 取引履歴一覧表示
- **目標**: 自分の支出をDBに保存し、取り出せること

### Phase 2: 「現状を知る」 ✅ v1.0.0完了
- [x] ダッシュボード実装
- [x] カテゴリ別円グラフ
- [x] 予算設定・残高表示
- **目標**: 「今月あといくら使えるか」が分かること

### Phase 3: 「未来を予測する」 ✅ v1.0.0完了
- [x] 月末着地予測の実装
- [x] 予算超過アラート
- [x] 日別推移グラフ
- **目標**: 「このままだと赤字になる」警告が出ること

### Phase 4: 「カスタマイズする」【v2.0.0】
- [ ] 背景設定機能（色/画像/グラデーション）
- [ ] 月カレンダー表示
- [ ] 週カレンダー表示
- [ ] 予算残額の大きな表示
- [ ] 設定画面の実装
- **目標**: ユーザーが自分好みにカスタマイズできること

---

## 7. デフォルトカテゴリ

### 支出カテゴリ
| 名前 | アイコン | 色 |
|------|---------|-----|
| 食費 | restaurant | #FF5722 |
| 交通費 | directions_car | #2196F3 |
| 日用品 | shopping_cart | #4CAF50 |
| 娯楽 | sports_esports | #9C27B0 |
| 医療 | local_hospital | #F44336 |
| 通信費 | phone | #00BCD4 |
| 光熱費 | bolt | #FFC107 |
| その他 | more_horiz | #607D8B |

### 収入カテゴリ
| 名前 | アイコン | 色 |
|------|---------|-----|
| 給料 | account_balance_wallet | #4CAF50 |
| 副収入 | attach_money | #8BC34A |
| その他収入 | more_horiz | #607D8B |

---

## 10. カレンダー画面設計【v2追加】

### 月カレンダー表示
```
     2025年12月
 日  月  火  水  木  金  土
     1   2   3   4   5   6
    ▼300 ▼1,200    ▲50,000
 7   8   9  10  11  12  13
...
```
- 支出は▼赤、収入は▲緑で表示
- タップで日別詳細モーダル表示

### 週カレンダー表示
```
12/23 月  12/24 火  12/25 水  ...
┌────────┬────────┬────────┐
│▼ ¥1,200│▼ ¥500 │        │
│食費    │交通費  │        │
├────────┼────────┼────────┤
│▼ ¥800  │        │▲¥50,000│
│日用品  │        │給料    │
└────────┴────────┴────────┘
```

---

## 11. 背景設定機能【v2追加】

### 背景タイプ
1. **単色**: カラーピッカーで選択
2. **グラデーション**: 2色選択 + 方向指定
3. **画像**: ギャラリーから選択 or プリセット

### 設定保存
- SharedPreferencesで永続化
- 背景画像はアプリ専用ディレクトリに保存

```mermaid
classDiagram
    class AppSettings {
        +String id
        +BackgroundType backgroundType
        +String backgroundValue
        +ThemeMode themeMode
        +bool showBudgetRemaining
        +CalendarView calendarDefaultView
    }
    
    class BackgroundType {
        <<enumeration>>
        COLOR
        GRADIENT
        IMAGE
    }
    
    class CalendarView {
        <<enumeration>>
        MONTH
        WEEK
    }
```